/*
 * Background.cpp
 *
 *  Created on: 29.08.2019
 *      Author: Trait
 */

#include "Background.h"
#include "xil_io.h"
#include "../definitions.h"

#define HEIGHT 100

Background::Background() {
	this->transitionOn = false;
	this->current_transition_offset = 56;
	this->desired_transition_offset = 56;
	this->score = 0;

	this->bg_tile1 = Highway;
	this->bg_tile2 = Grass;
	this->bg_tile3 = Highway;
	this->bg_tile4 = Highway;
	this->bg_tile5 = Water;
	this->bg_tile6 = Grass;
	this->bg_tile7 = Grass;
	this->bg_nxt = Highway;
}

void Background::setupTileBackground(uint16_t bg_type, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 4;
	uint32_t obj_data;
	bg_type &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (bg_type<<10) | pos_y;
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, obj_data);
}

void Background::draw(){
	setupTileBackground((uint8_t)bg_nxt, current_transition_offset, 0);
	setupTileBackground((uint8_t)bg_tile1, current_transition_offset + HEIGHT,1);
	setupTileBackground((uint8_t)bg_tile2, current_transition_offset + 2*HEIGHT,2);
	setupTileBackground((uint8_t)bg_tile3, current_transition_offset + 3*HEIGHT,3);
	setupTileBackground((uint8_t)bg_tile4, current_transition_offset + 4*HEIGHT,4);
	setupTileBackground((uint8_t)bg_tile5, current_transition_offset + 5*HEIGHT,5);
	setupTileBackground((uint8_t)bg_tile6, current_transition_offset + 6*HEIGHT,6);
	setupTileBackground((uint8_t)bg_tile7, current_transition_offset + 7*HEIGHT,7);
}

void Background::update() {
	if(current_transition_offset < desired_transition_offset) { //To change if not working as intended
		current_transition_offset++;
		transitionOn = true;
	}
	else if(current_transition_offset == 156){
		bg_tile7 = bg_tile6;
		bg_tile6 = bg_tile5;
		bg_tile5 = bg_tile4;
		bg_tile4 = bg_tile3;
		bg_tile3 = bg_tile2;
		bg_tile2 = bg_tile1;
		bg_tile1 = bg_nxt;
		bg_nxt = getRandomTile();
		current_transition_offset = desired_transition_offset = 56;
		transitionOn = false;
		setScore();
	}
}

enum Background::tileType Background::getRandomTile() {
	uint32_t random = Xil_In32(RNG_BASEADDR);

	if(random <= 85)
		return Background::Grass;
	else if(random <= 171)
		return Background::Highway;
	else
		return Background::Water;
}

uint8_t Background::getDesiredTransitionOffset() const {
	return desired_transition_offset;
}

void Background::setDesiredTransitionOffset(uint8_t desiredTransitionOffset) {
	desired_transition_offset = desiredTransitionOffset;
}

bool Background::isTransitionOn() const {
	return transitionOn;
}

enum Background::tileType Background::getBgNxt() const {
	return bg_nxt;
}
void Background::resetScore(){
	score = 10000;
	setScore();
}
void Background::setScore(){
	uint8_t module_id = 5;
	uint32_t obj_data;
	if (score == 10000)
		score = 0;
	else
		score++;
	obj_data = (module_id<<27) | (score<<21);
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, obj_data);
}

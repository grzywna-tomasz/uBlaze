/*
 * Empty C++ Application
 */

#include "xparameters.h"
#include "xil_io.h"
#include "sleep.h"

//Reg and control offsets
#define VGA_CONTROL_BASEADDR XPAR_VIDEO_CONTROLLER_4REGS_0_S00_AXI_BASEADDR
#define REG0_OFFSET 0
#define REG1_OFFSET 4
#define REG2_OFFSET 8
#define REG3_OFFSET 12

//Position offsets
#define FRAME_SIZE_OFFSET 12
#define TILE1_HEIGHT_OFFSET 56
#define TILE2_HEIGHT_OFFSET 156
#define TILE3_HEIGHT_OFFSET 256
#define TILE4_HEIGHT_OFFSET 356
#define TILE5_HEIGHT_OFFSET 456
#define TILE6_HEIGHT_OFFSET 556
#define TILE7_HEIGHT_OFFSET 656

//Background tiles
#define GRASS_TILE 1
#define HIGHWAY_TILE 2
#define WATER_TILE 3
#define TRAINWAY_TILE 4

//Void position
#define VOID_X 1024
#define VOID_Y 0

//old version
/*
void setFrogPosition(uint16_t pos_x, uint16_t pos_y){
	uint32_t pos_data;
	pos_x &= 0x7FF;
	pos_y &= 0x3FF;
	pos_data = (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG1_OFFSET, pos_data);
}
*/

void setupBackground(){
	//tiles displayed
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, TRAINWAY_TILE); //tile7
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, GRASS_TILE); //tile6
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, WATER_TILE); //tile5
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, HIGHWAY_TILE); //tile4
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, HIGHWAY_TILE); //tile3
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, GRASS_TILE); //tile2
	Xil_Out32(VGA_CONTROL_BASEADDR + REG3_OFFSET, HIGHWAY_TILE); //tile1
}

void setupFrog(uint16_t pos_x, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 1;
	uint32_t obj_data;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}

void setupCar(uint16_t pos_x, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 2;
	uint32_t obj_data;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}

void setupTruck(uint16_t pos_x, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 3;
	uint32_t obj_data;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}

void setupAllOnBlank(){
	setupFrog(VOID_X, VOID_Y, 1);
	for(uint8_t i = 1; i<6; i++){
		setupCar(VOID_X,VOID_Y, i);
		setupTruck(VOID_X,VOID_Y, i);
	}

}

int main()
{
	setupBackground();
	uint16_t frog_x = 12;
	uint16_t frog_y = 56;
	setupFrog(frog_x, frog_y, 1);

	uint16_t car0_x = FRAME_SIZE_OFFSET+10;
	uint16_t car1_x = FRAME_SIZE_OFFSET+110;
	uint16_t car2_x = FRAME_SIZE_OFFSET+210;
	uint16_t car3_x = FRAME_SIZE_OFFSET+610;
	uint16_t car4_x = FRAME_SIZE_OFFSET+510;


	while(1){


		if(car0_x != 0) car0_x -= 1;
		else car0_x = 1112;

		if(car1_x != 1112) car1_x += 1;
		else car1_x = 0;

		if(car2_x != 1112) car2_x += 1;
		else car2_x = 0;

		if(car3_x != 1112) car3_x += 1;
		else car3_x = 0;

		if(car4_x != 0) car4_x -= 1;
		else car4_x = 1112;


		if((frog_x<912) && (frog_y == 56))
			frog_x += 1;
		else if((frog_x==912) && (frog_y < 656))
			frog_y += 1;
		else if((frog_x>12) && (frog_y == 656))
			frog_x -= 1;
		else
			frog_y -= 1;

		setupCar(car0_x,TILE3_HEIGHT_OFFSET+10, 1);
		setupTruck(car1_x,TILE1_HEIGHT_OFFSET+10, 1);
		setupCar(car2_x,TILE4_HEIGHT_OFFSET+10, 2);
		setupCar(car3_x,TILE4_HEIGHT_OFFSET+10, 3);
		setupTruck(car4_x,TILE3_HEIGHT_OFFSET+10, 2);

		setupFrog(frog_x, frog_y, 1);
		usleep(2000);
	}
}

/*
 * Empty C++ Application
 */


#include "xparameters.h"
#include "xil_io.h"
#include "sleep.h"
//#include "xgpio.h"

//Used object classes
#include "Objects/Frog.h"
#include "Objects/Car.h"
#include "Objects/Controls.h"

//Used definitions and constants
#include "definitions.h"

//Temporary functions


/*
void setupFrog(uint16_t pos_x, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 1;
	uint32_t obj_data;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}
*/

void setupCar(uint16_t pos_x, uint16_t pos_y, uint8_t index, uint8_t direction){
	uint8_t module_id = 2;
	module_id &= 0xF;
	uint32_t obj_data;
	direction &= 0x1;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (direction << 31)| (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}

void setupTruck(uint16_t pos_x, uint16_t pos_y, uint8_t index){
	uint8_t module_id = 3;
	uint32_t obj_data;
	pos_x &= 0x7FF; //11bits
	pos_y &= 0x3FF; //10bits
	index &= 0x3F; //6bits
	obj_data = (module_id<<27) | (index<<21) | (pos_x<<10) | pos_y;
  	Xil_Out32(VGA_CONTROL_BASEADDR + REG2_OFFSET, obj_data);
}

void setupAllOnBlank(){
	//setupFrog(VOID_X, VOID_Y, 1);
	for(uint8_t i = 1; i<11; i++){
		setupCar(VOID_X,VOID_Y, i, 1);
		setupTruck(VOID_X,VOID_Y, i);
	}
}

//XGpio input;

uint16_t bg_type1 = HIGHWAY_TILE;
uint16_t bg_type2 = GRASS_TILE;
uint16_t bg_type3 = HIGHWAY_TILE;
uint16_t bg_type4 = HIGHWAY_TILE;
uint16_t bg_type5 = WATER_TILE;
uint16_t bg_type6 = TRAINWAY_TILE;
uint16_t bg_type7 = GRASS_TILE;
uint16_t bg_nxt = TRAINWAY_TILE;
uint16_t bg_nxt2 = 0;

uint16_t bgy = 256;
uint16_t desiredbgy = 0;
uint8_t bgcounter = 0;

uint16_t car0_y = TILE3_HEIGHT_OFFSET+82;
uint16_t car1_y = TILE1_HEIGHT_OFFSET+82;
uint16_t car2_y = TILE4_HEIGHT_OFFSET+82;
uint16_t car3_y = TILE4_HEIGHT_OFFSET+82;
uint16_t car4_y = TILE3_HEIGHT_OFFSET+82;

int main()
{

	Frog objFrog = Frog(446,690,1); //args: uint16_t posX, uint16_t posY, uint8_t speed);
	Frog *playerFrog = &objFrog;

	Controls objKeyboard = Controls(playerFrog); //args: Frog* ptr
	Controls *playerKeyboard = &objKeyboard;

	uint16_t car0_x = FRAME_SIZE_OFFSET+10;
	uint16_t car1_x = FRAME_SIZE_OFFSET+110;
	uint16_t car2_x = FRAME_SIZE_OFFSET+210;
	uint16_t car3_x = FRAME_SIZE_OFFSET+610;
	uint16_t car4_x = FRAME_SIZE_OFFSET+510;




	setupAllOnBlank();

	while(1){

		if(car0_x != 0) car0_x -= 1;
		else car0_x = 1200;

		if(car1_x != 1200) car1_x += 1;
		else car1_x = 0;

		if(car2_x != 1200) car2_x += 1;
		else car2_x = 0;

		if(car3_x != 1200) car3_x += 1;
		else car3_x = 0;

		if(car4_x != 0) car4_x -= 1;
		else car4_x = 1200;

		playerKeyboard->getKeyboardAction(bgy);
		playerFrog->updatePos();
		playerFrog->draw();

		setupCar(car0_x,car0_y, 1, 1);
		setupTruck(car1_x,car1_y, 1);
		setupCar(car2_x,car2_y, 2, 1);
		setupCar(car3_x,car3_y, 3, 0);
		setupTruck(car4_x,car4_y, 2);

		setupBackground();

		bgcounter += 1;

		usleep(2000);

	}
}
